<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J7-C USB Tester</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@6.0.0/dist/echarts.min.js"></script>
    <style>
        :root { --bg-color: #f9fafb; --text-color: #111827; --card-bg: #ffffff; --border-color: #e5e7eb; --accent: #6366f1; --stat-label: #6b7280; }
        @media (prefers-color-scheme: dark) { :root { --bg-color: #0f172a; --text-color: #f3f4f6; --card-bg: #1e293b; --border-color: #334155; --accent: #818cf8; --stat-label: #94a3b8; } }
        body { margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-color); font-family: sans-serif; transition: background 0.3s; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .header h1 { margin: 0; font-size: 1.5rem; }
        .header-controls { display: flex; align-items: center; gap: 15px; }
        
        .btn-download { text-decoration: none; font-size: 0.8rem; font-weight: bold; padding: 6px 12px; border-radius: 6px; background: var(--accent); color: white; transition: opacity 0.2s; }
        .btn-download:hover { opacity: 0.9; }

        .status-container { font-size: 0.9rem; font-weight: bold; display: flex; align-items: center; gap: 8px; padding: 6px 16px; border-radius: 20px; transition: all 0.3s; }
        .status-container.live { background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid #10b981; }
        .status-container.scanning { background: rgba(245, 158, 11, 0.1); color: #f59e0b; border: 1px solid #f59e0b; }
        .status-container.disconnected { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid #ef4444; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; display: inline-block; }
        .status-container.live .status-dot { animation: blink 1.5s infinite; }
        .status-container.scanning .status-dot { animation: pulse 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.2; } 100% { opacity: 1; } }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }
        
        .dashboard-grid { display: grid; grid-template-columns: 3fr 1fr; gap: 20px; }
        @media (max-width: 1000px) { .dashboard-grid { grid-template-columns: 1fr; } }
        #chart-container { width: 100%; height: 500px; background: var(--card-bg); border-radius: 12px; padding: 15px; box-sizing: border-box; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .side-panel { display: flex; flex-direction: column; gap: 15px; }
        .card { background: var(--card-bg); padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .card h3 { margin: 0 0 10px 0; font-size: 0.85rem; color: var(--accent); text-transform: uppercase; letter-spacing: 0.5px; }
        .live-value-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px; border-bottom: 1px dashed var(--border-color); }
        .live-value-label { font-size: 0.9rem; font-weight: 500; color: var(--stat-label); }
        .live-value { font-size: 1.4rem; font-weight: 700; font-feature-settings: "tnum"; }
        .unit { font-size: 0.6em; opacity: 0.7; margin-left: 2px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .stat-item { background: rgba(128,128,128,0.05); padding: 8px; border-radius: 6px; text-align: center; }
        .stat-label { font-size: 0.65rem; color: var(--stat-label); margin-bottom: 2px; text-transform: uppercase; }
        .stat-val { font-size: 0.9rem; font-weight: 600; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>J7-C Monitor</h1>
            <div class="header-controls">
                <a href="/download" class="btn-download" target="_blank">Download CSV</a>
                <div id="status-box" class="status-container disconnected"><span class="status-dot"></span><span id="status-text">Disconnected</span></div>
            </div>
        </div>
        <div class="dashboard-grid">
            <div id="chart-container"></div>
            <div class="side-panel">
                <div class="card">
                    <h3>Live Readings</h3>
                    <div class="live-value-row"><span class="live-value-label" style="color:#fbbf24;">Voltage</span><div class="live-value" id="val-v">--<span class="unit">V</span></div></div>
                    <div class="live-value-row"><span class="live-value-label" style="color:#3b82f6;">Current</span><div class="live-value" id="val-a">--<span class="unit">A</span></div></div>
                    <div class="live-value-row"><span class="live-value-label" style="color:#ef4444;">Power</span><div class="live-value" id="val-w">--<span class="unit">W</span></div></div>
                    <div class="live-value-row"><span class="live-value-label" style="color:#f97316;">Temp</span><div class="live-value" id="val-t">--<span class="unit">°C</span></div></div>
                </div>
                <div class="card">
                    <h3>Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-item"><div class="stat-label">Max Voltage</div><div class="stat-val" id="stat-max-v">-- V</div></div>
                        <div class="stat-item"><div class="stat-label">Avg Voltage</div><div class="stat-val" id="stat-avg-v">-- V</div></div>
                        <div class="stat-item"><div class="stat-label">Max Current</div><div class="stat-val" id="stat-max-a">-- A</div></div>
                        <div class="stat-item"><div class="stat-label">Avg Current</div><div class="stat-val" id="stat-avg-a">-- A</div></div>
                        <div class="stat-item"><div class="stat-label">Max Power</div><div class="stat-val" id="stat-max-w">-- W</div></div>
                        <div class="stat-item"><div class="stat-label">Avg Power</div><div class="stat-val" id="stat-avg-w">-- W</div></div>
                        <div class="stat-item"><div class="stat-label">Max Temp</div><div class="stat-val" id="stat-max-t">-- °C</div></div>
                        <div class="stat-item"><div class="stat-label">Avg Temp</div><div class="stat-val" id="stat-avg-t">-- °C</div></div>
                        <div class="stat-item" style="grid-column: span 2; margin-top: 5px;"><div class="stat-label">Total Duration</div><div class="stat-val" id="stat-time">00:00:00</div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const chartDom = document.getElementById('chart-container');
        const myChart = echarts.init(chartDom);
        let data = { v: [], a: [], w: [], t: [], time: [] };
        const maxDataPoints = 3600; 
        function getThemeColors() {
            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            return {
                text: isDark ? '#f3f4f6' : '#374151',
                splitLine: isDark ? '#334155' : '#e5e7eb',
                tooltipBg: isDark ? 'rgba(30, 41, 59, 0.95)' : 'rgba(255, 255, 255, 0.95)',
                tooltipText: isDark ? '#fff' : '#000'
            };
        }
        function updateChartOption() {
            const colors = getThemeColors();
            myChart.setOption({
                backgroundColor: 'transparent',
                tooltip: { trigger: 'axis', axisPointer: { type: 'cross' }, backgroundColor: colors.tooltipBg, textStyle: { color: colors.tooltipText } },
                legend: { top: 'top', data: ['Voltage', 'Current', 'Power', 'Temp'], textStyle: { color: colors.text } },
                grid: { left: '2%', right: '2%', bottom: '2%', top: '15%', containLabel: true },
                xAxis: { type: 'category', boundaryGap: false, data: data.time, axisLabel: { color: colors.text } },
                yAxis: [
                    { type: 'value', name: 'V / W', position: 'left', splitLine: { lineStyle: { color: colors.splitLine } }, axisLabel: { color: colors.text } },
                    { type: 'value', name: 'A', position: 'right', splitLine: { show: false }, axisLabel: { color: colors.text } },
                    { type: 'value', name: '°C', position: 'right', offset: 40, splitLine: { show: false }, axisLabel: { color: colors.text } }
                ],
                series: [
                    { name: 'Voltage', type: 'line', showSymbol: false, yAxisIndex: 0, data: data.v, itemStyle: { color: '#fbbf24' } }, 
                    { name: 'Current', type: 'line', showSymbol: false, yAxisIndex: 1, data: data.a, itemStyle: { color: '#3b82f6' } },
                    { name: 'Power', type: 'line', showSymbol: false, yAxisIndex: 0, data: data.w, itemStyle: { color: '#ef4444' }, lineStyle: { width: 2 } }, // Solid Red Line
                    { name: 'Temp', type: 'line', showSymbol: false, yAxisIndex: 2, data: data.t, itemStyle: { color: '#f97316' }, areaStyle: { opacity: 0.05 } } 
                ]
            });
        }
        updateChartOption();
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateChartOption);
        window.addEventListener('resize', myChart.resize);

        let stats = { maxV: 0, sumV: 0, maxA: 0, sumA: 0, maxW: 0, sumW: 0, maxT: 0, sumT: 0, count: 0 };

        function updateStatsUI() {
            if (stats.count === 0) return;
            document.getElementById('stat-max-v').innerText = stats.maxV.toFixed(2) + ' V';
            document.getElementById('stat-avg-v').innerText = (stats.sumV / stats.count).toFixed(2) + ' V';
            document.getElementById('stat-max-a').innerText = stats.maxA.toFixed(2) + ' A';
            document.getElementById('stat-avg-a').innerText = (stats.sumA / stats.count).toFixed(2) + ' A';
            document.getElementById('stat-max-w').innerText = stats.maxW.toFixed(2) + ' W';
            document.getElementById('stat-avg-w').innerText = (stats.sumW / stats.count).toFixed(2) + ' W';
            document.getElementById('stat-max-t').innerText = stats.maxT + ' °C';
            document.getElementById('stat-avg-t').innerText = (stats.sumT / stats.count).toFixed(1) + ' °C';
            const hours = Math.floor(stats.count / 3600);
            const minutes = Math.floor((stats.count % 3600) / 60);
            const seconds = stats.count % 60;
            document.getElementById('stat-time').innerText = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function processDataPoint(d) {
            stats.count++;
            stats.maxV = Math.max(stats.maxV, d.voltage); stats.sumV += d.voltage;
            stats.maxA = Math.max(stats.maxA, d.current); stats.sumA += d.current;
            stats.maxW = Math.max(stats.maxW, d.power); stats.sumW += d.power;
            stats.maxT = Math.max(stats.maxT, d.temperature); stats.sumT += d.temperature;
            
            const date = new Date(d.timestamp);
            const timeStr = date.toLocaleTimeString('en-US', { hour12: false });
            
            data.time.push(timeStr);
            data.v.push(d.voltage); data.a.push(d.current); 
            data.w.push(d.power); data.t.push(d.temperature);

            if (data.time.length > maxDataPoints) {
                data.time.shift(); data.v.shift(); data.a.shift(); data.w.shift(); data.t.shift();
            }
        }

        function updateStatusUI(state, text) {
            const box = document.getElementById('status-box');
            const txt = document.getElementById('status-text');
            box.className = 'status-container'; 
            txt.innerText = text;
            if (state === 'live') box.classList.add('live');
            else if (state === 'scan') box.classList.add('scanning');
            else box.classList.add('disconnected');
        }

        const protocol = window.location.protocol === "https:" ? "wss" : "ws";
        const wsUrl = `${protocol}://${window.location.host}/ws`;
        let socket;

        function connect() {
            socket = new WebSocket(wsUrl);
            socket.onopen = () => console.log("WS Connected");
            socket.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                if (msg.type === 'history') {
                    const history = msg.data;
                    data = { v: [], a: [], w: [], t: [], time: [] };
                    stats = { maxV: 0, sumV: 0, maxA: 0, sumA: 0, maxW: 0, sumW: 0, maxT: 0, sumT: 0, count: 0 };
                    history.forEach(processDataPoint);
                    updateStatsUI();
                    myChart.setOption({ xAxis: { data: data.time }, series: [ { data: data.v }, { data: data.a }, { data: data.w }, { data: data.t } ] });
                } else if (msg.type === 'data') {
                    updateStatusUI('live', 'LIVE MONITORING');
                    const d = msg.data;
                    document.getElementById('val-v').innerHTML = `${d.voltage.toFixed(2)}<span class="unit">V</span>`;
                    document.getElementById('val-a').innerHTML = `${d.current.toFixed(2)}<span class="unit">A</span>`;
                    document.getElementById('val-w').innerHTML = `${d.power.toFixed(2)}<span class="unit">W</span>`;
                    document.getElementById('val-t').innerHTML = `${d.temperature}<span class="unit">°C</span>`;
                    processDataPoint(d);
                    updateStatsUI();
                    myChart.setOption({ xAxis: { data: data.time }, series: [ { data: data.v }, { data: data.a }, { data: data.w }, { data: data.t } ] });
                } else if (msg.type === 'status') {
                    const txt = msg.msg.toLowerCase();
                    if (txt.includes('scanning') || txt.includes('connecting')) updateStatusUI('scan', msg.msg);
                    else if (txt.includes('retrying') || txt.includes('error') || txt.includes('disconnect')) updateStatusUI('disconnected', msg.msg);
                    else updateStatusUI('scan', msg.msg);
                }
            };
            socket.onclose = () => { updateStatusUI('disconnected', 'Server Disconnected'); setTimeout(connect, 3000); };
        }
        connect();
    </script>
</body>
</html>
